#!/usr/bin/env bash

apache_confdir="/etc/apache2/sites-available"

# grab the different document roots 
for docroot in $(grep -o 'DocumentRoot.*' $apache_confdir/* | \
    awk '{if ($2 ~ "/data/www/*") print $2}') ; do
    
    pmf_output_dir=$(echo $docroot |egrep -o '[^/]*/[^/]*$')
    mkdir -p /tmp/$pmf_output_dir

    SAVEIFS=$IFS
    IFS=$(echo -en "\n\b")
    find $docroot -type f -iname "*php" -exec yara /etc/phpmalwarefinder/malwares.yara {} > \
    /tmp/$pmf_output_dir/cron.out 2>&1 \;

    if [ -s /tmp/$pmf_output_dir/cron.out ]; then
      cat /tmp/$pmf_output_dir/cron.out | \
      mail -s "PMF REPORT:$(uname -n) DocumentRoot $docroot" jre@nbs-system.com
    fi;
done
