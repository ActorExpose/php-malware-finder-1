#!/bin/bash

YARA=$(which yara)
CONFIG_PATH='/etc/phpmalwarefinder/malwares.yara'

if [ ! -f "$YARA" ]
then
	YARA='./yara'
fi

if [ ! -f "$CONFIG_PATH" ]
then
	CONFIG_PATH='./malwares.yara'
fi

show_help() {
    cat << EOF
Usage ${0##*/} [-cfhw] <file|folder> ...
    -c  Optional path to a configuration file
    -f  Fast mode
    -h  Show this help message
    -v  Verbose mode
EOF
}

OPTIND=1
while getopts "c:fhv" opt; do
    case "$opt" in
        h)
            show_help
            exit 0
            ;;
        f)
            OPTS="${OPTS} -f"
            ;;
        c)
            CONFIG_PATH=${OPTARG}
            ;;
        v)
            OPTS="${OPTS} -s"
            ;;
        '?')
            show_help
            exit 1
            ;;
    esac
done
shift "$((OPTIND-1))"

if [ ! -e ${YARA} ]
then
    echo "Can't find yara. Did you installed it?"
    exit 1
fi

if [ ! -e ${CONFIG_PATH} ]
then
    echo "${CONFIG_PATH} doesn't exist. Please give me a valid file."
    exit 1
fi

if [ -z $@ ]
then
	show_help
	exit 1
fi

OPTS="${OPTS} -r ${CONFIG_PATH}"

ionice -c3 $YARA $OPTS $@
